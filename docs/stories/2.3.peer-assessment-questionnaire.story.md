# Story 2.3: Peer-Assessment Questionnaire

**Epic:** 2 - The Questionnaire Engine

**User Story:** As a Party Member, I want to answer questions about my fellow party members, so that I can contribute to the group's perception of their stats.

## Acceptance Criteria

1.  After completing the self-assessment, the user is presented with a series of 'peer-assessment' questions fetched from the database.
2.  For each question, the user must provide an answer for every *other* member of the party.
3.  The UI must present a random selection of party members for each question, ensuring each user gets an equal number of assessments over time. (Note: Future implementation will include weighting to ensure balanced participation)
4.  All answers are saved to the `answers` table in Supabase, linked to the voting user (the one answering), the subject user (the one being answered about), and the specific question.
5.  Upon completing the last question for the last party member, the user is taken to the Lobby/Waiting screen.
6.  The user's status in the `party_members` table is updated to 'Finished' upon completion.

## Dev Notes

*   **Data Fetching**: The component will need to fetch the list of 'peer-assessment' questions and the list of other party members.
*   **UI State Management**: State will be needed to track the current question index and the current party member being assessed.
*   **Data Submission**: A mutation will be required to save the answers to the `answers` table. It may be more efficient to batch the answers and submit them all at once upon completion.
*   **Navigation**: Use Next.js router to navigate the user to the lobby page (`/party/[code]`) upon completion.
*   **Component Structure**:
    *   A main container component for the questionnaire page (`/party/[code]/questionnaire/peer/page.tsx`).
    *   A component to display the current question.
    *   A component to handle the selection of answers for a specific user.
    *   A mechanism (e.g., tabs, carousel) to switch between party members for the current question.

## Testing

*   Manual testing will be performed to verify the flow.
*   Verify that answers are correctly saved in the `answers` table in Supabase.
*   Verify the user is redirected to the lobby upon completion.
*   Verify the user's status is updated to 'Finished'.

## Dev Agent Record

### Agent Model Used
gemini-2.5-pro

### Debug Log References
_N/A_

### Completion Notes
- Implemented a pre-calculated peer assessment distribution system to ensure fairness.
- Created a new table `peer_assessment_assignments` to store the distribution.
- Created a new database function `generate_peer_assessment_distribution` to populate the assignments.
- The distribution is generated when the first user in a party starts the questionnaire.
- The frontend now fetches and uses these assignments to display the correct assessment targets.

### File List
- `friend-party-app/database/migrations/20250715125400_create_peer_assessment_assignments.sql` (created)
- `friend-party-app/database/migrations/20250715125500_create_generate_peer_assessment_distribution_function.sql` (created)
- `friend-party-app/database/init.sql` (modified)
- `friend-party-app/src/app/api/party/[code]/start-questionnaire/route.ts` (modified)
- `friend-party-app/src/app/api/party/[code]/peer-assessment-assignments/route.ts` (created)
- `friend-party-app/src/components/common/UnifiedQuestionnaire.tsx` (modified)
- `friend-party-app/src/types/questionnaire.ts` (modified)
- `friend-party-app/src/store/partyStore.ts` (modified)

### Change Log
- Added `peer_assessment_assignments` table and `generate_peer_assessment_distribution` function to the database.
- Modified `start-questionnaire` API to trigger assignment generation.
- Added `peer-assessment-assignments` API to fetch assignments.
- Updated `UnifiedQuestionnaire` to use the new assignment system.
- Updated `PartyMember` type in `questionnaire.ts` and `partyStore.ts`.

**Status:** Ready for Review