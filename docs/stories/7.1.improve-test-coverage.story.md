# Epic 7.1: Improve Test Coverage

## Story Overview
**Epic**: 7.1  
**Title**: Improve Test Coverage  
**Priority**: High  
**Estimated Effort**: 3-4 sprints  
**Status**: Ready for Development  

## Problem Statement
The current test coverage is critically low at 6.43% statements and 6.43% lines, significantly below the configured 25% threshold. This creates significant risk for:
- Undetected bugs in production
- Regression issues during refactoring
- Difficulty maintaining code quality
- Reduced confidence in deployments

## Current Coverage Analysis

### Overall Coverage Metrics
- **Statements**: 6.43% (697/10,825) ❌
- **Branches**: 71.73% (198/276) ✅
- **Functions**: 60.3% (79/131) ✅
- **Lines**: 6.43% (697/10,825) ❌

### Coverage by Category

#### ✅ Well-Tested Areas (High Coverage)
- **`app/api/admin/settings`**: 100% statements, 87.5% branches, 100% functions, 100% lines
- **`components/ui`**: 93.52% statements, 100% branches, 91.66% functions, 93.52% lines
- **`store`**: 90.9% statements, 73.07% branches, 100% functions, 90.9% lines
- **`utils`**: 100% statements, 100% branches, 100% functions, 100% lines
- **`components/common`**: 69.84% statements, 84.37% branches, 90.9% functions, 69.84% lines

#### ⚠️ Moderately Tested Areas
- **`hooks`**: 12.8% statements, 66.66% branches, 44.44% functions, 12.8% lines
- **`lib`**: 12.17% statements, 75.75% branches, 73.33% functions, 12.17% lines

#### ❌ Untested Areas (0% Coverage)
- **All API routes** (except admin/settings): 0% coverage across the board
- **All page components**: 0% coverage
- **Most components**: 0% coverage (except UI and common components)
- **Minigame components**: 0% coverage
- **Type definitions**: 0% coverage

## Current Test Issues
- **25 out of 152 tests are failing** - must be fixed first
- Test failures may be affecting coverage collection accuracy
- Many tests have mocking issues (Supabase client mocking problems)
- Some tests have infinite recursion issues

## Success Criteria
- [ ] Fix all 25 failing tests
- [ ] Achieve minimum 25% coverage across all metrics (statements, branches, functions, lines)
- [ ] Achieve 80%+ coverage for critical business logic
- [ ] Achieve 60%+ coverage for API routes
- [ ] Achieve 50%+ coverage for page components
- [ ] All new code includes tests (enforced via CI/CD)

## Implementation Plan

### Phase 1: Fix Existing Tests (Sprint 1)
- [ ] Fix 25 failing tests
- [ ] Resolve Supabase mocking issues
- [ ] Fix infinite recursion in vote route tests
- [ ] Fix table name mismatches in settings tests
- [ ] Ensure all tests pass consistently

### Phase 2: API Route Testing (Sprint 2)
- [ ] Test critical API routes:
  - [ ] `app/api/party/[code]/join` - Party joining logic
  - [ ] `app/api/party/[code]/mottos` - Motto management
  - [ ] `app/api/party/[code]/propose-motto` - Motto proposals
  - [ ] `app/api/party/[code]/vote` - Voting system
  - [ ] `app/api/party/[code]/vote-hireling-conversion` - Hireling conversion
- [ ] Test error handling and edge cases
- [ ] Test authentication and authorization
- [ ] Test input validation

### Phase 3: Page Component Testing (Sprint 3)
- [ ] Test critical page components:
  - [ ] `app/party/[code]/page.tsx` - Main party page
  - [ ] `app/party/[code]/results/page.tsx` - Results display
  - [ ] `app/create/page.tsx` - Party creation
  - [ ] `app/profile/page.tsx` - User profile
- [ ] Test user interactions and state management
- [ ] Test responsive design and accessibility

### Phase 4: Component and Hook Testing (Sprint 4)
- [ ] Test remaining components:
  - [ ] Minigame components
  - [ ] Achievement and avatar components
  - [ ] Questionnaire components
- [ ] Test custom hooks:
  - [ ] `useAchievements`
  - [ ] `useAvatars`
  - [ ] `useMinigameAccess`
  - [ ] `useMinigameSession`
- [ ] Test complex business logic

## Testing Strategy

### Test Types
1. **Unit Tests**: Individual functions and components
2. **Integration Tests**: API routes with database interactions
3. **Component Tests**: React components with user interactions
4. **E2E Tests**: Critical user flows (optional for this epic)

### Testing Tools
- **Vitest**: Primary testing framework
- **@testing-library/react**: Component testing
- **@testing-library/jest-dom**: DOM assertions
- **MSW**: API mocking (if needed)
- **Vitest coverage**: Coverage reporting

### Coverage Targets
- **Critical Business Logic**: 80%+ coverage
- **API Routes**: 60%+ coverage
- **Page Components**: 50%+ coverage
- **Utility Functions**: 90%+ coverage (already achieved)
- **UI Components**: 80%+ coverage (mostly achieved)

## Technical Requirements

### Test Setup
- [ ] Ensure consistent test environment setup
- [ ] Fix Supabase client mocking
- [ ] Create reusable test utilities
- [ ] Set up proper test data fixtures

### CI/CD Integration
- [ ] Add coverage reporting to CI pipeline
- [ ] Set up coverage thresholds enforcement
- [ ] Add coverage badges to README
- [ ] Block merges if coverage drops below threshold

### Code Quality
- [ ] Ensure all tests are maintainable and readable
- [ ] Use descriptive test names and good test structure
- [ ] Avoid flaky tests
- [ ] Keep tests fast and reliable

## Acceptance Criteria

### Definition of Done
- [ ] All existing tests pass consistently
- [ ] Coverage meets minimum thresholds (25% overall, higher for critical areas)
- [ ] New tests follow established patterns and conventions
- [ ] Coverage reports are generated and accessible
- [ ] CI/CD pipeline enforces coverage requirements
- [ ] Documentation updated with testing guidelines

### Quality Gates
- [ ] No failing tests in CI/CD
- [ ] Coverage threshold enforcement working
- [ ] All critical user flows have test coverage
- [ ] Test suite runs in under 5 minutes
- [ ] Tests are deterministic and reliable

## Dependencies
- Fix existing test infrastructure issues
- Resolve Supabase mocking problems
- Update CI/CD pipeline for coverage enforcement

## Risks and Mitigation
- **Risk**: Fixing failing tests may reveal deeper issues
  - **Mitigation**: Address issues incrementally, prioritize critical functionality
- **Risk**: High coverage targets may slow development
  - **Mitigation**: Focus on critical areas first, use coverage as a guide not a strict requirement
- **Risk**: Test maintenance overhead
  - **Mitigation**: Establish good testing patterns and documentation

## Future Considerations
- Consider adding E2E tests for critical user flows
- Implement visual regression testing for UI components
- Add performance testing for critical operations
- Consider mutation testing to validate test quality

## Notes
- This epic should be prioritized highly due to the current low coverage
- Consider pairing with other epics to add tests as features are developed
- Focus on business-critical functionality first
- Ensure all new code includes tests going forward
